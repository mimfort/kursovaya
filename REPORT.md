# Отчёт по курсовой работе: Telegram-бот для генерации и проверки задач

## Введение и цель
Цель курсовой — разработать учебный Telegram-бот, который автоматически формирует индивидуальные варианты заданий по алгебре и геометрии, выдаёт их в PDF и проверяет ответы ученика. Бот ведёт учёт пользователей, наборов задач, попыток решений и собирает статистику.

## Функциональные требования
- Регистрация ученика (ФИО, класс) по команде `/start`.
- Генерация набора задач по выбранному предмету, уровню сложности и количеству (1–15).
- Отправка варианта в PDF с указанием ученика, предмета, номера набора и QR-ссылки на бота.
- Приём и проверка ответов по порядку; фиксация результата и факта «подсмотра».
- Завершение набора с кратким итогом.
- Просмотр статистики: всего попыток, верных, по предметам/темам, за 7 дней, количество подсказок.
- Справка `/help` с правилами ввода ответов.

## Технологический стек
- Язык: Python 3.12.
- Telegram: `aiogram 3` (FSM, роутеры, клавиатуры).
- БД: `SQLite` (по умолчанию) с `SQLAlchemy 2 async`. Возможна замена на PostgreSQL через DSN.
- PDF/QR: `reportlab`, `qrcode[pil]`.
- Математика: `decimal`, `fractions` (гарантированно конечные десятичные ответы).
- Тесты: `pytest`.
- Конфигурация: `.env`, `python-dotenv`.

## Архитектура проекта
- Точка входа: `main.py` — загрузка настроек, инициализация БД, создание `Bot`/`Dispatcher`, регистрация роутеров, запуск polling.
- Конфигурация и логи (`core/`):
  - `config.py` — загрузка переменных окружения: `BOT_TOKEN`, `DATABASE_URL`, `PDF_DIR`, `BOT_NAME`; создание каталога для PDF.
  - `logging.py` — базовый логгер на stdout.
- Доступ к данным (`db/`):
  - `models.py` — таблицы `User`, `TaskSet`, `GeneratedTask`, `AnswerAttempt`, перечисление предметов `Subject`.
  - `base.py` — `create_async_engine`, фабрика сессий `async_sessionmaker`, `init_db()` для создания схемы.
  - `repository.py` — CRUD пользователя, создание наборов/задач, выбор незавершённого набора, сохранение попыток, агрегация статистики.
- Доменная логика задач (`tasks/`):
  - `generator.py` — генерация заданий для алгебры/геометрии; ответы — конечные десятичные дроби или целые.
  - `checker.py` — валидация формата ответа и сравнение через `Decimal` с допуском `1e-6`.
- PDF (`pdf/generator.py`) — создание `taskset_{id}.pdf`: шапка с данными ученика и набора, обёртка текста, QR на бота (если задан `BOT_NAME`), попытка подключить кириллический шрифт (Arial/Times).
- Бот (`bot/`):
  - `states.py` — FSM: `Registration`, `GenerateTasks`, `CheckingAnswers`.
  - `keyboards.py` — reply/inline-клавиатуры (старт, меню, предмет, сложность, повтор/показ ответа).
  - `handlers/start.py` — `/start`, `/help`, регистрация.
  - `handlers/tasks.py` — генерация варианта, выдача PDF, проверка ответов, повтор, показ правильного ответа, завершение набора.
  - `handlers/stats.py` — вывод статистики.
- Тесты (`tests/`) — проверка генерации (конечные десятичные ответы) и правил сравнения ответов.

## Сценарии (FSM)
1. **Регистрация**: `/start` → кнопка «Зарегистрироваться» → ввод ФИО → ввод класса → запись в `users`.
2. **Новый вариант**: «Новый вариант» → выбор предмета → выбор сложности → ввод количества задач → генерация и запись в `task_sets`/`generated_tasks` → PDF → переход к проверке.
3. **Проверка/Продолжение**: по порядку вводятся ответы на задачи. При верном — переход к следующей. При неверном — кнопки «Решить ещё раз» / «Узнать ответ» (сохранение попытки с `looked_answer=True`). После последней задачи набор помечается `is_completed=True`, показывается итог.
4. **Статистика**: кнопка «Статистика» — вывод агрегатов по предметам, темам, 7-дневному окну и количеству подсказок.
5. **Справка**: `/help` — формат ответов и основные шаги.

## Структура базы данных
- `users`: `tg_id` (уникальный), `full_name`, `grade`, `created_at`.
- `task_sets`: `user_id`, `subject`, `total_tasks`, `is_completed`, `created_at`.
- `generated_tasks`: `task_set_id`, `order_index`, `subject`, `topic`, `difficulty`, `text`, `correct_answer`, `created_at`.
- `answer_attempts`: `task_id`, `user_id`, `user_answer`, `is_correct`, `looked_answer`, `created_at`.

## Генерация заданий
- Алгебра: арифметика десятичных, линейные и квадратные уравнения, уравнение вида `ax^2 = bx`, пропорции, задачи на вероятность. Ответы строятся из дробей со знаменателем вида `2^a*5^b`, что гарантирует конечную десятичную форму; округление до тысячных.
- Геометрия: углы, элементы треугольника, площади (по стороне и высоте или катетам), периметры. Ответы — целые или конечные десятичные.
- Каждое задание имеет `topic` и `difficulty` (easy/normal/hard).

## Проверка ответов
- Допустимый ввод: целые или десятичные дроби с точкой или запятой (`-?\d+[.,]\d+`). Обыкновенные дроби и проценты не принимаются.
- Нормализация: замена запятой на точку, тримминг пробелов.
- Сравнение: `Decimal`, допуск `1e-6`. При неверном ответе предлагается повтор или показ правильного ответа (фиксируется как подсказка).

## Генерация PDF
- Имя файла: `taskset_{id}.pdf` в каталоге `PDF_DIR`.
- Содержимое: шапка (ученик, класс, предмет, номер набора, количество задач), памятка по формату ответа, QR на бота (если задано `BOT_NAME`), список задач с ручной обёрткой строк.
- Шрифт: попытка подключить системный Arial/Times для поддержки кириллицы; при отсутствии — fallback на Helvetica.

## Конфигурация и запуск
- Переменные `.env`:
  - `BOT_TOKEN` — токен Telegram-бота (обязательно).
  - `DATABASE_URL` — DSN БД, по умолчанию `sqlite+aiosqlite:///./bot.db`.
  - `PDF_DIR` — каталог для сохранения PDF, по умолчанию `./generated_pdfs`.
  - `BOT_NAME` — имя бота без `@` для QR (опционально).
- Установка зависимостей: `pip install -e .` или перечислить пакеты из `pyproject.toml`.
- Запуск: `python main.py` или `make run`. База и таблицы создаются автоматически (`init_db()`).

## Тестирование
- Команда: `pytest -q` или `make test`.
- Покрытие:
  - Генератор всегда выдаёт ответы, представимые как конечные десятичные.
  - Чекер корректно различает допустимый формат, знак и запрещает обыкновенные дроби/проценты.

## Нефункциональные аспекты и эксплуатация
- Логи: базовая конфигурация `logging` на stdout (можно заменить на файловый/structured логер).
- Масштабирование: при переходе на PostgreSQL достаточно сменить DSN; модели совместимы, асинхронный движок поддерживается.
- Устойчивость: все операции с БД — через `async` сессии и явный `commit`.
- Хранение файлов: PDF сохраняются локально; при необходимости можно отдать в S3/облако, заменив путь на URL.
- Безопасность: токен хранится в `.env`; пользователь идентифицируется по `tg_id`. Ввод ограничен ожидаемым форматом.

## Возможные улучшения
- Добавить новые предметы/темы и веса сложности.
- История выполненных наборов с повторной выдачей PDF.
- Более детальная статистика (время на задачу, попытки до верного).
- Локализация интерфейса, антиспам (rate limit), кэширование генератора.
- CI для автотестов и линтеров, контейнеризация (Docker).

## Заключение
Реализованный бот автоматизирует выдачу и проверку учебных заданий, хранит историю попыток и предоставляет базовую аналитику. Проект демонстрирует применение асинхронного стека Python (aiogram + SQLAlchemy), генерацию PDF/QR и работу с конечными десятичными дробями для надёжной проверки ответов.
