# Курсовая: Telegram-бот для генерации и проверки задач

Этот репозиторий содержит учебный Telegram-бот, который генерирует варианты задач по алгебре и геометрии, отдаёт их в PDF и проверяет ответы пользователя. Ниже собрана полная текстовая часть для курсовой: архитектура, сценарии, устройство базы и ключевые решения в коде.

## Назначение и функции
- Регистрация ученика (ФИО, класс) по `/start`, сохранение в БД.
- Генерация набора задач по выбранному предмету, уровню сложности и количеству (1–15); PDF с заданиями и QR на бота.
- Проверка ответов по порядковому номеру задач, фиксация результата и факта «подсмотра».
- Итоговые сообщения по завершении набора и вкладка «Статистика» с агрегированными показателями.

## Технологический стек
- `aiogram 3` — FSM, роутеры, клавиатуры.
- `SQLAlchemy 2 async` + `SQLite` — хранение пользователей, наборов, задач и попыток.
- `reportlab` + `qrcode` — генерация PDF с кириллицей и QR на бота.
- `decimal`/`fractions` — гарантированно конечные десятичные ответы и сравнение с допуском.
- `pytest` — автотесты генератора и чекера.

## Архитектура и ключевые модули
- `main.py` — точка входа: загрузка настроек, инициализация БД, создание `Bot`/`Dispatcher`, регистрация роутеров и запуск polling.
- `core/` — обвязка:
  - `config.py` — чтение `.env` (BOT_TOKEN, DATABASE_URL, PDF_DIR, BOT_NAME), создание каталога для PDF.
  - `logging.py` — базовая настройка логов на stdout.
- `db/`:
  - `models.py` — таблицы `User`, `TaskSet`, `GeneratedTask`, `AnswerAttempt`, перечисление предметов `Subject`.
  - `base.py` — движок `create_async_engine`, фабрика сессий `async_sessionmaker`, `init_db()` для создания схемы.
  - `repository.py` — слой доступа к данным: CRUD пользователя, создание набора и задач, выбор текущего набора, сохранение попыток, агрегация статистики.
- `tasks/`:
  - `generator.py` — фабрика задач. Для алгебры: арифметика с десятичными, линейные/квадратные уравнения, пропорции, вероятность. Для геометрии: углы, элементы, площади и периметр треугольника. Все ответы — конечные десятичные дроби (ограничение знаменателя 2^a*5^b) или целые.
  - `checker.py` — валидация формата ответа (`-?\d+[.,]\d+` или целое), нормализация запятой/точки, сравнение через `Decimal` с допуском `1e-6`. Обыкновенные дроби и проценты отвергаются.
- `pdf/generator.py` — создание файла `taskset_{id}.pdf`: кириллический шрифт (подключение Arial/Times при наличии), шапка с данными ученика, предметом и количеством задач, обертка текста по ширине, QR со ссылкой на бота, сохранение в `PDF_DIR`.
- `bot/`:
  - `states.py` — FSM состояния регистрации, генерации и проверки.
  - `keyboards.py` — reply/inline-клавиатуры (выбор предмета, сложности, меню после PDF, повтор/показ ответа).
  - `handlers/start.py` — `/start`, `/help`, регистрация.
  - `handlers/tasks.py` — генерация варианта, отправка PDF, цикл проверки ответов, повтор, показ правильного ответа, завершение набора.
  - `handlers/stats.py` — вывод агрегированной статистики.
- `tests/` — проверка генерации ответов (конечные десятичные, приводимость к Fraction) и правил сравнения ответов.

## Сценарии работы бота
- **Регистрация:** `/start` → кнопка «Зарегистрироваться» → ввод ФИО → ввод класса. Пользователь сохраняется в БД, повторный вход показывает главное меню.
- **Новый вариант:** «Новый вариант» → выбор предмета (`algebra`/`geometry`) → выбор сложности (`easy/normal/hard` сохраняется в БД) → ввод количества задач (1–15) → генерация задач и запись в `task_sets`/`generated_tasks` → PDF → предложение перейти к проверке.
- **Проверка / Продолжение:** ввод ответа на текущую задачу по порядку. При верном ответе — переход к следующей; при неверном — кнопки «Решить ещё раз» или «Узнать ответ» (фиксируется `looked_answer=True`). После последней задачи набор помечается завершённым, выводится краткое резюме.
- **Статистика:** команда «Статистика» возвращает общее число попыток, число верных, разбивку по предметам и темам, количество подсмотров и результаты за последние 7 дней.
- **Help:** `/help` — краткая памятка и формат ответов.

## Схема данных
- `users`: `tg_id` (уникальный), `full_name`, `grade`, `created_at`.
- `task_sets`: ссылка на пользователя, `subject`, `total_tasks`, `is_completed`, `created_at`.
- `generated_tasks`: ссылка на набор, `order_index`, `subject`, `topic`, `difficulty`, `text`, `correct_answer`.
- `answer_attempts`: ссылка на задачу и пользователя, `user_answer`, `is_correct`, `looked_answer`, `created_at`.

## Правила генерации и проверки
- Алгебраические задачи формируются так, чтобы ответ был конечной десятичной дробью (генерация дробей с знаменателем вида 2^a*5^b и округление до тысячных). Геометрия выдаёт целые либо конечные дробные значения периметров/площадей/углов.
- Допустимый ввод: только целые числа или десятичные дроби с точкой или запятой. Погрешность сравнения — `1e-6`. Значения с процентами, обыкновенными дробями или лишними символами считаются неверными.
- Фиксация подсказок: при нажатии «Узнать ответ» в БД создаётся попытка с флагом `looked_answer=True`, что отображается в статистике.

## Установка и запуск
1) Подготовить Python 3.12+ и зависимости:
```
pip install -e .
# или pip install aiogram SQLAlchemy aiosqlite greenlet python-dotenv reportlab qrcode[pil] pytest
```
2) Создать файл `.env` в корне:
```
BOT_TOKEN=ваш_токен_бота
DATABASE_URL=sqlite+aiosqlite:///./bot.db   # можно заменить на другой DSN
PDF_DIR=./generated_pdfs                    # каталог для PDF
BOT_NAME=имя_бота_без_@                     # нужно для QR, опционально
```
3) Запустить бота:
```
python main.py
# или make run
```
База создаётся автоматически при старте (`init_db()`), PDF сохраняются в `PDF_DIR`.

## Тестирование
Запуск автотестов: `pytest -q` или `make test`. Они проверяют, что генератор всегда выдаёт корректно представимые ответы, а сравнение ответов соблюдает правила формата и знака.

## Краткая структура проекта
- `main.py` — запуск.
- `core/` — конфиг и логирование.
- `db/` — модели, фабрика сессий, репозиторий.
- `tasks/` — генерация и проверка задач.
- `pdf/` — создание PDF.
- `bot/handlers/` — сценарии регистрации, задач, статистики; `bot/keyboards.py`, `bot/states.py`.
- `tests/` — Pytest.
- `generated_pdfs/` — целевые файлы (создаётся автоматически).

## Развёртывание и сопровождение
- Перенос на другой СУБД: изменить `DATABASE_URL` (например, PostgreSQL через `postgresql+asyncpg://`), типы в `models.py` совместимы.
- Изменение набора тем: добавлять/редактировать генераторы в `tasks/generator.py` и учитывать новые `topic` в статистике.
- Шаблон PDF: настраивается в `pdf/generator.py` (отступы, шапка, шрифт, QR).
- Расширение сценариев бота: добавить новые роутеры/клавиатуры и зарегистрировать их в `main.py`.

Этот README можно использовать как текстовую часть курсовой: он описывает цель, функционал, архитектуру, правила генерации/проверки и эксплуатационные шаги.
